# 弹丸收集小车电控系统设计文档
## 一、电控系统准备阶段：软件学习、工具选型与协作体系搭建

### 功能描述
准备阶段是电控系统开发的基础支撑环节，核心目标包含三部分：一是掌握STM32CubeMX与编程软件的使用，构建开发技术能力；二是确定统一的编程工具，解决协作效率问题；三是搭建基于GitHub的协作体系，通过文档管理与任务分配规范开发流程，确保团队成员目标一致、进度同步，为后续硬件驱动与控制逻辑开发铺平道路。

### 开发历程

#### 1. 核心软件学习规划与落地
针对电控系统开发的技术需求，团队围绕“工具使用+功能实现”制定分层学习计划，确保成员快速具备独立开发能力：
- **STM32CubeMX学习**：聚焦“外设配置与代码生成”核心能力，以机械部件需求为导向（如舵机变形需定时器PWM、麦克纳姆轮驱动需GPIO方向控制），通过“案例实操+参数验证”的方式学习。例如，通过“配置TIM4生成20ms周期PWM驱动MG995舵机”“配置GPIO推挽输出控制L298N使能端”等小实验，掌握时钟树分配（72MHz主频下定时器分频计算）、引脚复用冲突规避等关键操作，1周内实现全员可独立生成基础外设初始化代码。
- **编程软件学习**：重点突破HAL库函数调用与调试逻辑，针对“电机转速调节”“串口数据收发”“中断回调函数编写”等高频场景

#### 2. 编程工具选型：从双工具并行到统一CLion
项目初期因成员技术背景差异采用双工具方案，后续因协作与稳定性问题优化为单一工具，具体迭代过程如下：
- **初始双工具选型原因**：
  - 选择**Keil5**：参考多数STM32入门教程，其对HAL库兼容性成熟，且具备完整的编译、下载、在线调试功能，适合零基础成员快速上手；
  - 选择**CLion**：一名成员此前有C++开发经验，熟悉CLion的CMake构建、代码自动补全与重构功能，编写复杂控制逻辑（如麦克纳姆轮差速算法）时效率更高，因此初期采用“一人用CLion、一人用Keil5”的并行方案，尝试兼容不同开发习惯。

- **双工具并行的核心问题**：
  - **协作效率低**：Keil5的Project工程与CLion的CMakeLists.txt工程文件不互通，成员需通过GitHub手动同步代码，且代码格式（如缩进、注释）、文件组织结构易出现差异，每次合并需花费1-2小时核对，严重拖慢开发进度；
  - **Keil5稳定性不足**：Keil5（V5.38版本）在Win11系统下偶发“工程文件损坏”“下载后程序跑飞”等问题，需重启软件或重新生成工程，单次故障排查耗时平均30分钟以上，影响开发连续性；
  - **功能局限性**：Keil5对多文件管理、代码搜索的支持较弱，随着驱动模块增多（如扇叶电机、舵机、麦克纳姆轮），查找函数、修改变量变得繁琐，而CLion的“全局搜索”“跳转定义”功能可大幅提升效率。

- **工具统一决策**：
  经过1周并行测试后，团队召开技术会议，综合评估“协作效率、稳定性、功能适配”三大维度，最终决定**全员切换至CLion**。核心依据：① CLion的现代化功能更适配复杂项目开发，且有经验成员可通过“一对一指导”帮助零基础成员快速掌握操作；② 解决双工具代码同步问题，减少无效沟通成本；③ 规避Keil5的兼容性故障，降低开发风险。

#### 3. 基于GitHub的协作体系搭建（经验成员带领）
为解决“开发进度不同步、文档缺失、任务责任不明确”问题，由组内有GitHub使用经验的成员牵头，搭建全员参与的协作体系丸收集小车电控开发”专属仓库。

#### 4. 核心问题与解决方案
- **环境配置问题**：CLion与ARM-GCC、OpenOCD工具链版本不兼容，出现“编译报错”“无法识别ST-Link下载器”。解决方案：参考B站教程与经验成员，统一安装ARM-GCC 10.3版本（与OpenOCD 0.11版本适配），在CLion“Settings”中手动指定工具链路径，同时通过“编译日志”定位缺失文件，逐步完善CMakeLists.txt配置；
- **GitHub协作问题**：部分成员不熟悉Git命令（如commit、push、pull），导致代码提交冲突。解决方案：经验成员开展1次Git基础培训，（含“拉取代码git pull、提交代码git add/commit/push、解决冲突步骤”），并通过“模拟提交”练习确保全员掌握基础操作；

#### 5. 阶段成果
- **技术能力**：全员掌握STM32CubeMX外设配置与CLion编程调试，可独立完成“舵机角度控制”“电机PWM调速”等基础功能开发；
- **协作体系**：搭建完成基于GitHub的文档管理与任务跟踪体系任务进度透明度提升；
- **工具统一**：实现CLion单一工具开发，代码同步效率较双工具阶段提升，Keil5稳定性问题彻底解决，开发故障排查时间缩短至10分钟以内。

## 二、底盘控制模块开发

### 功能描述
底盘控制模块是小车运动的核心控制单元，负责实现麦克纳姆轮的全向移动（前进、后退、左右平移、原地旋转），通过STM32的GPIO引脚控制电机方向、定时器输出PWM信号调节电机转速，同时需适配机械结构中“一侧相同”的轮组安装方式，确保控制逻辑与轮组运动特性匹配。本模块的开发过程也是团队熟悉STM32CubeMX引脚配置与HAL库基础操作的关键实践阶段。

### 开发历程

#### 1. 麦克纳姆轮控制逻辑解析与实现
基于机械设计中“一侧相同”的轮组安装方式（左侧两轮旋转方向一致，右侧两轮旋转方向相反），团队首先明确麦克纳姆轮的运动控制逻辑，核心原理如下：
- **直线运动**：左侧两轮与右侧两轮同向同速旋转（如均正向旋转时小车前进，均反向旋转时后退）；
- **左右平移**：左侧两轮反向旋转（前正后反），右侧两轮反向旋转（前反后正），通过轮组产生的侧向力驱动小车平移；
- **原地旋转**：左侧两轮正向旋转，右侧两轮反向旋转（或反之），利用两侧轮组的反向扭矩实现旋转。

为实现上述逻辑，需完成两项核心配置：
- **GPIO引脚分配**：使用4组GPIO引脚（每组2个）连接L298N电机驱动模块的IN1~IN4接口，通过高低电平组合控制电机转向（如IN1=1、IN2=0时电机正转，IN1=0、IN2=1时反转）；
- **PWM信号输出**：通过TIM3的4个通道（CH1~CH4）输出PWM信号至L298N的ENA~ENB接口，调节占空比（0~100%）控制电机转速。

在STM32CubeMX中完成配置后，通过HAL库函数实现基础控制：
```c
// 电机方向控制（示例：左前轮正转）
HAL_GPIO_WritePin(GPIOC, GPIO_PIN_0, GPIO_PIN_SET);  // IN1=1
HAL_GPIO_WritePin(GPIOC, GPIO_PIN_1, GPIO_PIN_RESET); // IN2=0

// PWM转速控制（示例：左前轮转速50%）
__HAL_TIM_SET_COMPARE(&htim3, TIM_CHANNEL_1, 500);  // 假设Period=1000
```

#### 2. 开发过程中的核心问题与解决方案
本阶段的主要挑战集中在“基础操作不熟练”导致的技术问题，具体如下：

- **问题1：引脚配置错误导致电机无响应**  
  初期因对STM32CubeMX引脚功能理解不足，出现两种配置错误：① 将电机方向控制引脚误配置为“输入模式”（GPIO_MODE_INPUT），导致无法输出高低电平；② 未启用对应GPIO端口的时钟（如忘记调用`__HAL_RCC_GPIOC_CLK_ENABLE()`），引脚始终无输出。  
  解决方案：通过查阅STM32参考手册，明确GPIO配置需同时设置“模式”（推挽输出GPIO_MODE_OUTPUT_PP）、“速度”（GPIO_SPEED_FREQ_MEDIUM）及“时钟使能”，并在CubeMX中通过“Pinout”视图反复核对引脚功能，最终形成《GPIO配置检查表》（包含端口、引脚号、模式、时钟使能状态），每次配置后对照检查，避免重复错误。

- **问题2：HAL库函数调用错误导致编译失败**  
  编写控制代码时，因对HAL库函数参数理解不清晰，出现“函数参数类型不匹配”“未声明的函数引用”等编译错误。例如，误将`HAL_GPIO_WritePin()`的第二个参数写成引脚编号整数（如`0`），而非库定义的宏（`GPIO_PIN_0`）；或未在代码中包含定时器驱动头文件（`#include "tim.h"`），导致`__HAL_TIM_SET_COMPARE()`函数无法识别。  
  解决方案：① 整理常用HAL库函数手册（含函数名、参数类型、功能描述），如`HAL_GPIO_WritePin(GPIO_TypeDef *GPIOx, uint16_t GPIO_Pin, GPIO_PinState PinState)`的参数要求；② 利用CLion的代码补全功能（输入函数名后自动提示参数），减少手动输入错误；③ 编译报错时，优先查看错误提示中的“undefined reference to”或“invalid argument”信息，定位缺失的头文件或参数错误，逐步修正。

- **问题3：烧录失败与程序运行异常**  
  多次出现“ST-Link无法识别芯片”“烧录后程序无反应”等问题，经排查原因包括：① ST-Link与开发板的SWD接口接线错误（SWCLK与SWDIO接反）；② 程序中未启用SysTick定时器（HAL库延时函数`HAL_Delay()`依赖SysTick，未配置会导致程序卡死）；③ 烧录前未编译生成最新hex文件（CLion需手动点击“Build”按钮，否则烧录旧版本代码）。  
  解决方案：① 制作SWD接口接线图（标注ST-Link的SWCLK接开发板PA14，SWDIO接PA13），贴在开发板上便于核对；② 在CubeMX中开启SysTick定时器（默认配置为1ms中断），确保`HAL_Delay()`正常工作；③ 制定“编译-烧录”标准化流程（修改代码→Build→连接ST-Link→点击Download），并通过LED闪烁测试（编写简单程序让LED周期性亮灭）验证烧录是否成功。

#### 3. 功能验证与迭代优化
通过分阶段测试验证底盘控制功能：
- **单电机测试**：逐一控制四个轮子的正转、反转、停止，通过示波器测量PWM波形，确保占空比调节准确（如50%占空比对应波形高电平持续时间为周期的一半）；
- **组合运动测试**：验证直线前进/后退（速度0.8m/s）、左右平移（速度0.5m/s）、原地旋转（一周0.8秒）的流畅性，通过调整PWM占空比补偿轮组摩擦力差异（如右侧轮组因负载稍大，PWM占空比提高5%以保证直线行驶不偏移）；

#### 4. 阶段成果
- **控制功能**：实现麦克纳姆轮全向移动；
- **技术掌握**：全员熟练掌握STM32CubeMX引脚配置（GPIO、定时器）与HAL库基础操作（高低电平控制、PWM输出），可独立排查编译与烧录错误；
