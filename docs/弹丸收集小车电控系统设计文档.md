# 弹丸收集小车电控系统设计文档
## 一、电控系统准备阶段：软件学习、工具选型与协作体系搭建

### 功能描述
准备阶段是电控系统开发的基础支撑环节，核心目标包含三部分：一是掌握STM32CubeMX与编程软件的使用，构建开发技术能力；二是确定统一的编程工具，解决协作效率问题；三是搭建基于GitHub的协作体系，通过文档管理与任务分配规范开发流程，确保团队成员目标一致、进度同步，为后续硬件驱动与控制逻辑开发铺平道路。

### 开发历程

#### 1. 核心软件学习规划与落地
针对电控系统开发的技术需求，团队围绕“工具使用+功能实现”制定分层学习计划，确保成员快速具备独立开发能力：
- **STM32CubeMX学习**：聚焦“外设配置与代码生成”核心能力，以机械部件需求为导向（如舵机变形需定时器PWM、麦克纳姆轮驱动需GPIO方向控制），通过“案例实操+参数验证”的方式学习。例如，通过“配置TIM4生成20ms周期PWM驱动MG995舵机”“配置GPIO推挽输出控制L298N使能端”等小实验，掌握时钟树分配（72MHz主频下定时器分频计算）、引脚复用冲突规避等关键操作，1周内实现全员可独立生成基础外设初始化代码。
- **编程软件学习**：重点突破HAL库函数调用与调试逻辑，针对“电机转速调节”“串口数据收发”“中断回调函数编写”等高频场景

#### 2. 编程工具选型：从双工具并行到统一CLion
项目初期因成员技术背景差异采用双工具方案，后续因协作与稳定性问题优化为单一工具，具体迭代过程如下：
- **初始双工具选型原因**：
  - 选择**Keil5**：参考多数STM32入门教程，其对HAL库兼容性成熟，且具备完整的编译、下载、在线调试功能，适合零基础成员快速上手；
  - 选择**CLion**：一名成员此前有C++开发经验，熟悉CLion的CMake构建、代码自动补全与重构功能，编写复杂控制逻辑（如麦克纳姆轮差速算法）时效率更高，因此初期采用“一人用CLion、一人用Keil5”的并行方案，尝试兼容不同开发习惯。

- **双工具并行的核心问题**：
  - **协作效率低**：Keil5的Project工程与CLion的CMakeLists.txt工程文件不互通，成员需通过GitHub手动同步代码，且代码格式（如缩进、注释）、文件组织结构易出现差异，每次合并需花费1-2小时核对，严重拖慢开发进度；
  - **Keil5稳定性不足**：Keil5（V5.38版本）在Win11系统下偶发“工程文件损坏”“下载后程序跑飞”等问题，需重启软件或重新生成工程，单次故障排查耗时平均30分钟以上，影响开发连续性；
  - **功能局限性**：Keil5对多文件管理、代码搜索的支持较弱，随着驱动模块增多（如扇叶电机、舵机、麦克纳姆轮），查找函数、修改变量变得繁琐，而CLion的“全局搜索”“跳转定义”功能可大幅提升效率。

- **工具统一决策**：
  经过1周并行测试后，团队召开技术会议，综合评估“协作效率、稳定性、功能适配”三大维度，最终决定**全员切换至CLion**。核心依据：① CLion的现代化功能更适配复杂项目开发，且有经验成员可通过“一对一指导”帮助零基础成员快速掌握操作；② 解决双工具代码同步问题，减少无效沟通成本；③ 规避Keil5的兼容性故障，降低开发风险。

#### 3. 基于GitHub的协作体系搭建（经验成员带领）
为解决“开发进度不同步、文档缺失、任务责任不明确”问题，由组内有GitHub使用经验的成员牵头，搭建全员参与的协作体系丸收集小车电控开发”专属仓库。

#### 4. 核心问题与解决方案
- **环境配置问题**：CLion与ARM-GCC、OpenOCD工具链版本不兼容，出现“编译报错”“无法识别ST-Link下载器”。解决方案：参考B站教程与经验成员，统一安装ARM-GCC 10.3版本（与OpenOCD 0.11版本适配），在CLion“Settings”中手动指定工具链路径，同时通过“编译日志”定位缺失文件，逐步完善CMakeLists.txt配置；
- **GitHub协作问题**：部分成员不熟悉Git命令（如commit、push、pull），导致代码提交冲突。解决方案：经验成员开展1次Git基础培训，（含“拉取代码git pull、提交代码git add/commit/push、解决冲突步骤”），并通过“模拟提交”练习确保全员掌握基础操作；

#### 5. 阶段成果
- **技术能力**：全员掌握STM32CubeMX外设配置与CLion编程调试，可独立完成“舵机角度控制”“电机PWM调速”等基础功能开发；
- **协作体系**：搭建完成基于GitHub的文档管理与任务跟踪体系任务进度透明度提升；
- **工具统一**：实现CLion单一工具开发，代码同步效率较双工具阶段提升，Keil5稳定性问题彻底解决，开发故障排查时间缩短至10分钟以内。

## 二、底盘控制模块开发

### 功能描述
底盘控制模块是小车运动的核心控制单元，负责实现麦克纳姆轮的全向移动（前进、后退、左右平移、原地旋转），通过STM32的GPIO引脚控制电机方向、定时器输出PWM信号调节电机转速，同时需适配机械结构中“一侧相同”的轮组安装方式，确保控制逻辑与轮组运动特性匹配。本模块的开发过程也是团队熟悉STM32CubeMX引脚配置与HAL库基础操作的关键实践阶段。

### 开发历程

#### 1. 麦克纳姆轮控制逻辑解析与实现
基于机械设计中“一侧相同”的轮组安装方式（左侧两轮旋转方向一致，右侧两轮旋转方向相反），团队首先明确麦克纳姆轮的运动控制逻辑，核心原理如下：
- **直线运动**：左侧两轮与右侧两轮同向同速旋转（如均正向旋转时小车前进，均反向旋转时后退）；
- **左右平移**：左侧两轮反向旋转（前正后反），右侧两轮反向旋转（前反后正），通过轮组产生的侧向力驱动小车平移；
- **原地旋转**：左侧两轮正向旋转，右侧两轮反向旋转（或反之），利用两侧轮组的反向扭矩实现旋转。

为实现上述逻辑，需完成两项核心配置：
- **GPIO引脚分配**：使用4组GPIO引脚（每组2个）连接L298N电机驱动模块的IN1~IN4接口，通过高低电平组合控制电机转向（如IN1=1、IN2=0时电机正转，IN1=0、IN2=1时反转）；
- **PWM信号输出**：通过TIM3的4个通道（CH1~CH4）输出PWM信号至L298N的ENA~ENB接口，调节占空比（0~100%）控制电机转速。

在STM32CubeMX中完成配置后，通过HAL库函数实现基础控制：
```c
// 电机方向控制（示例：左前轮正转）
HAL_GPIO_WritePin(GPIOC, GPIO_PIN_0, GPIO_PIN_SET);  // IN1=1
HAL_GPIO_WritePin(GPIOC, GPIO_PIN_1, GPIO_PIN_RESET); // IN2=0

// PWM转速控制（示例：左前轮转速50%）
__HAL_TIM_SET_COMPARE(&htim3, TIM_CHANNEL_1, 500);  // 假设Period=1000
```

#### 2. 开发过程中的核心问题与解决方案
本阶段的主要挑战集中在“基础操作不熟练”导致的技术问题，具体如下：

- **问题1：引脚配置错误导致电机无响应**  
  初期因对STM32CubeMX引脚功能理解不足，出现两种配置错误：① 将电机方向控制引脚误配置为“输入模式”（GPIO_MODE_INPUT），导致无法输出高低电平；② 未启用对应GPIO端口的时钟（如忘记调用`__HAL_RCC_GPIOC_CLK_ENABLE()`），引脚始终无输出。  
  解决方案：通过查阅STM32参考手册，明确GPIO配置需同时设置“模式”（推挽输出GPIO_MODE_OUTPUT_PP）、“速度”（GPIO_SPEED_FREQ_MEDIUM）及“时钟使能”，并在CubeMX中通过“Pinout”视图反复核对引脚功能，最终形成《GPIO配置检查表》（包含端口、引脚号、模式、时钟使能状态），每次配置后对照检查，避免重复错误。

- **问题2：HAL库函数调用错误导致编译失败**  
  编写控制代码时，因对HAL库函数参数理解不清晰，出现“函数参数类型不匹配”“未声明的函数引用”等编译错误。例如，误将`HAL_GPIO_WritePin()`的第二个参数写成引脚编号整数（如`0`），而非库定义的宏（`GPIO_PIN_0`）；或未在代码中包含定时器驱动头文件（`#include "tim.h"`），导致`__HAL_TIM_SET_COMPARE()`函数无法识别。  
  解决方案：① 整理常用HAL库函数手册（含函数名、参数类型、功能描述），如`HAL_GPIO_WritePin(GPIO_TypeDef *GPIOx, uint16_t GPIO_Pin, GPIO_PinState PinState)`的参数要求；② 利用CLion的代码补全功能（输入函数名后自动提示参数），减少手动输入错误；③ 编译报错时，优先查看错误提示中的“undefined reference to”或“invalid argument”信息，定位缺失的头文件或参数错误，逐步修正。

- **问题3：烧录失败与程序运行异常**  
  多次出现“ST-Link无法识别芯片”“烧录后程序无反应”等问题，经排查原因包括：① ST-Link与开发板的SWD接口接线错误（SWCLK与SWDIO接反）；② 程序中未启用SysTick定时器（HAL库延时函数`HAL_Delay()`依赖SysTick，未配置会导致程序卡死）；③ 烧录前未编译生成最新hex文件（CLion需手动点击“Build”按钮，否则烧录旧版本代码）。  
  解决方案：① 制作SWD接口接线图（标注ST-Link的SWCLK接开发板PA14，SWDIO接PA13），贴在开发板上便于核对；② 在CubeMX中开启SysTick定时器（默认配置为1ms中断），确保`HAL_Delay()`正常工作；③ 制定“编译-烧录”标准化流程（修改代码→Build→连接ST-Link→点击Download），并通过LED闪烁测试（编写简单程序让LED周期性亮灭）验证烧录是否成功。

#### 3. 功能验证与迭代优化
通过分阶段测试验证底盘控制功能：
- **单电机测试**：逐一控制四个轮子的正转、反转、停止，通过示波器测量PWM波形，确保占空比调节准确（如50%占空比对应波形高电平持续时间为周期的一半）；
- **组合运动测试**：验证直线前进/后退（速度0.8m/s）、左右平移（速度0.5m/s）、原地旋转（一周0.8秒）的流畅性，通过调整PWM占空比补偿轮组摩擦力差异（如右侧轮组因负载稍大，PWM占空比提高5%以保证直线行驶不偏移）；

#### 4. 阶段成果
- **控制功能**：实现麦克纳姆轮全向移动；
- **技术掌握**：全员熟练掌握STM32CubeMX引脚配置（GPIO、定时器）与HAL库基础操作（高低电平控制、PWM输出），可独立排查编译与烧录错误；

## 三、通信模块开发：PS2手柄与STM32通信实现

### 功能描述
通信模块是小车人机交互的核心，负责建立PS2手柄与STM32控制板的双向数据传输，将手柄按键指令（如方向键、功能键）转化为电控系统可识别的控制信号，为后续“手柄控制底盘运动、收集装置启停”奠定基础。本阶段的核心验证目标是通过手柄按键实现STM32控制板上LED灯的亮暗切换，确保通信链路稳定、指令解析准确。

### 开发历程

#### 1. 通信方案选型与硬件连接
基于比赛场景对“控制延迟、抗干扰性”的需求，团队选择PS2手柄作为控制终端，核心原因在于：PS2手柄采用**无线2.4G通信**，传输距离可达10米（覆盖比赛场地范围），且信号抗干扰能力强，相比蓝牙通信延迟更低（指令响应≤50ms）；同时PS2手柄按键数量充足（含方向键、功能键），可满足“底盘运动、收集扇叶启停、舵机变形”等多维度控制需求。当然主要原因是大赛举办方提供了PS2通信的设备和相关教程

硬件连接方面，PS2接收器需与STM32控制板通过4根信号线连接，对应引脚分配如下（结合前期PA4~PA7预留通信引脚的设计）：
- PS2接收器的DI（数据输入）→ STM32的PA4（GPIO推挽输出，用于STM32向接收器发送数据）；
- PS2接收器的CMD（命令信号）→ STM32的PA5（GPIO推挽输出，用于同步通信时序）；
- PS2接收器的CS（片选信号）→ STM32的PA6（GPIO推挽输出，用于使能接收器）；
- PS2接收器的CLK（时钟信号）→ STM32的PA7（GPIO推挽输出，用于提供通信时钟）；
- 接收器VCC接5V电源，GND与STM32共地（确保电平匹配，避免信号干扰）。

#### 2. 代码开发与核心功能实现
通信模块的代码开发围绕“PS2手柄指令解析”展开，核心流程为：STM32通过IO口模拟PS2通信协议，向接收器发送读取指令→接收器返回手柄按键数据（16位数据帧，每一位对应一个按键状态）→STM32解析数据帧，判断按键是否按下→根据按键状态控制LED灯亮暗（如按下“SELECT”键点亮LED1，按下“START”键熄灭LED1）。

关键代码逻辑如下（基于适配接收器的代码框架修改的伪代码）：
```c
// 读取PS2手柄数据
uint16_t ps2_data = PS2_ReadData(); 

// 解析按键：SELECT键按下（数据帧第12位为0表示按下）
if((ps2_data & (1 << 11)) == 0) { 
    HAL_GPIO_WritePin(GPIOB, GPIO_PIN_0, GPIO_PIN_SET); // LED1点亮
}

// 解析按键：START键按下（数据帧第13位为0表示按下）
if((ps2_data & (1 << 12)) == 0) { 
    HAL_GPIO_WritePin(GPIOB, GPIO_PIN_0, GPIO_PIN_RESET); // LED1熄灭
}
```

#### 3. 开发过程中的核心问题与解决方案
本阶段的问题主要集中在“代码适配性”与“硬件连接”，具体排查与解决过程如下：

- **问题1：不适配的文档代码导致通信失败**  
  初期参考网络上通用的PS2通信代码（基于某款第三方接收器），烧录后STM32始终无法读取到有效按键数据，通过串口打印调试发现返回数据帧全为0xFF（无效值）。经分析，问题根源在于**代码与接收器型号不匹配**：不同品牌的PS2接收器通信时序（CLK时钟频率、数据帧格式）存在差异，通用代码的时序参数（如延时函数时长）无法适配团队所使用的接收器，导致数据传输同步失败。  
  解决方案：① 查阅所购PS2接收器的官方手册，确认其通信时序要求（如CLK时钟周期需≥10us）；② 在GitHub与B站搜索同型号接收器的开源代码，对比发现通用代码中`PS2_SendCmd()`函数的延时仅5us，不符合本接收器要求；③ 修改延时函数，将`HAL_Delay_us(5)`改为`HAL_Delay_us(15)`，重新烧录后成功读取到有效数据帧。

- **问题2：引脚设置差异导致硬件连线错误**  
  由于参考的多份PS2代码中引脚分配不同（如某份代码将CS接PA8，另一份将CS接PA6），团队在硬件连线时未注意代码中的引脚定义，误将PS2接收器的CS接至STM32的PA8（代码中实际定义CS为PA6），导致“代码配置引脚”与“实际硬件连线”不匹配，通信链路始终处于断开状态。初期排查时仅关注代码逻辑与供电，未发现引脚连线错误，问题卡壳2天。  
  解决方案：① 在学长提示下，采用“代码引脚定义与硬件连线逐一核对”的方法，打开代码中的`ps2.h`文件，找到引脚宏定义（如`#define PS2_CS_GPIO_Port GPIOB`），与硬件连线逐一对比；② 发现CS引脚连线错误后，重新焊接将接收器CS接至PA6，同时在代码中统一所有引脚定义（DI=PA4、CMD=PA5、CS=PA6、CLK=PA7），确保“代码配置-硬件连线”完全一致；③ 制定“引脚核对表”，后续模块开发前需先确认代码中的引脚定义与硬件连线是否匹配，避免同类错误。

#### 4. 功能验证与稳定性测试
通过多轮测试验证通信模块性能：
- **基础功能验证**：按下PS2手柄的R1键，STM32控制板上LED1点亮；松开R1键，LED1熄灭;
- **兼容性测试**：更换2个同型号PS2手柄，均能正常与接收器通信，确保手柄故障时可快速替换。

#### 5. 阶段成果
- **通信功能**：实现PS2手柄与STM32的稳定通信；
- **问题解决能力**：建立“代码适配性排查”“引脚核对”等问题解决流程，可独立处理通信协议与硬件连接类错误；

## 四、收集装置控制模块开发

### 功能描述
收集装置控制模块负责驱动机械结构中的核心执行部件，通过精准控制舵机实现收集装置的“收起-展开”变形动作，通过电机驱动扇叶旋转完成弹丸收集，需满足比赛中“快速响应变形指令、扇叶转速稳定可控”的需求，同时确保两种执行器的控制逻辑互不干扰，适配小车整体运行节奏。

### 开发历程

#### 1. 执行器控制方案设计
根据收集装置的机械特性，明确两类执行器的控制需求及方案：
- **舵机控制（MG995舵机）**：需实现两个固定角度的切换（收起状态约0°，展开状态约90°），依赖**PWM信号的占空比调节**（舵机通过识别20ms周期内高电平持续时间判断目标角度：0.5ms对应0°，2.5ms对应180°）。因此选择STM32的TIM4_CH3（PB7引脚）输出PWM信号，通过修改占空比控制舵机旋转至目标角度。
- **扇叶电机控制**：需实现“启动-停止-调速”功能，依赖**GPIO高低电平控制启停**与**PWM占空比调节转速**（电机通过L298N驱动模块连接，IN引脚控制方向，ENA引脚接收PWM信号）。选择STM32的TIM2_CH1（PA0引脚）输出PWM调节转速，GPIOA_PIN_1控制电机启停（高电平启动，低电平停止）。

#### 2. 代码实现与核心逻辑
基于STM32CubeMX完成外设配置后（TIM4设置为20ms周期PWM，TIM2设置为10kHz高频PWM），编写控制代码(伪代码)：
- **舵机角度控制**：
  ```c
  // 收起状态（0°）：高电平持续0.5ms，占空比2.5%（0.5ms/20ms）
  __HAL_TIM_SET_COMPARE(&htim4, TIM_CHANNEL_3, 500);  // 假设Period=20000（20ms）
  
  // 展开状态（90°）：高电平持续1.5ms，占空比7.5%（1.5ms/20ms）
  __HAL_TIM_SET_COMPARE(&htim4, TIM_CHANNEL_3, 1500);
  ```
- **扇叶电机控制**：
  ```c
  // 启动电机并设置转速为70%
  HAL_GPIO_WritePin(GPIOA, GPIO_PIN_1, GPIO_PIN_SET);  // 使能电机
  __HAL_TIM_SET_COMPARE(&htim2, TIM_CHANNEL_1, 700);   // 假设Period=1000（10kHz）
  
  // 停止电机
  HAL_GPIO_WritePin(GPIOA, GPIO_PIN_1, GPIO_PIN_RESET); // 禁用电机
  ```

#### 3. 开发过程中的核心问题与解决方案
本阶段的主要难点在于舵机与电机控制原理的差异，导致初期开发中出现多个技术卡点：

- **问题1：舵机角度偏差与抖动**  
  初期控制舵机时，发现实际角度与目标角度偏差达10°以上，且静止时存在明显抖动。经分析，原因包括：① 舵机PWM周期配置错误（误将TIM4周期设为10ms，而非标准20ms，导致舵机无法识别角度信号）；② 未预留足够的角度调节时间（发送角度指令后立即执行其他操作，舵机未完成旋转即被中断）；③ 电源电压不稳定（舵机启动时电流波动影响PWM信号输出）。  
  解决方案：① 在CubeMX中重新配置TIM4，将预分频器设为7199（72MHz主频下，7199+1=7200分频，计数频率10kHz），自动重装载值设为199（10kHz×0.02s=200，即20ms周期），确保PWM周期符合舵机要求；② 在角度切换代码后添加`HAL_Delay(500)`，预留0.5秒让舵机完成旋转；③ 为舵机单独供电（通过外部5V电源模块，与STM32电源隔离），减少电流波动干扰，最终角度偏差控制在±2°以内，抖动现象消除。

- **问题2：对舵机与电机控制原理的理解混淆**  
  团队初期因未区分两类执行器的控制逻辑，出现“用电机控制思维编写舵机代码”的错误：例如，试图通过GPIO高低电平直接控制舵机角度（类似电机启停），而非调节PWM占空比；或在扇叶电机控制中，误将PWM周期设为20ms（舵机周期），导致电机转速异常（高频振动而非稳定旋转）。  
  解决方案：① 开展专题学习，明确核心差异：舵机是“位置伺服器件”，依赖PWM占空比对应角度；电机是“速度器件”，依赖PWM占空比对应平均电压（转速），且需高频PWM（10kHz以上）避免振动；② 制作“执行器控制对比表”，汇总两者的PWM周期、控制信号类型、驱动方式等关键参数，贴在开发板上随时参考；③ 通过“分模块测试”验证逻辑，先单独调试舵机（用LED指示角度切换完成），再单独调试电机（用转速计测量转速），最后合并代码，确保原理理解无误。
